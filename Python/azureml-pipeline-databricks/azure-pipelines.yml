pr: none
trigger:
  branches:
    include:
    - master
  paths:
    include:
    - infrastructure/

variables:
- group: terraform

pool:
  vmImage: ubuntu-latest

jobs:
- template: infrastructure/terraform-job-template.yml
  parameters:
    environment: test
    TerraformBackendResourceGroup: $(TERRAFORM_BACKEND_RG)
    TerraformBackendStorageAccount: $(TERRAFORM_BACKEND_STORAGE)
    TerraformEnvVariables:
      TF_VAR_location: $(LOCATION)
      TF_VAR_devops_mlpipeline_sp_object_id: $(MLPIPELINE_SP_OBJECT_ID)
      TF_VAR_aml_run_sp_client_id: $(AML_RUN_SP_CLIENT_ID)
      TF_VAR_aml_run_sp_client_secret: $(AML_RUN_SP_CLIENT_SECRET)

- job: Post_terraform
  dependsOn: Terraform
  variables:
    RESOURCE_GROUP: $[ dependencies.Terraform.outputs['TerraformOutputs.resource_group_name'] ]
    WORKSPACE_NAME: $[ dependencies.Terraform.outputs['TerraformOutputs.aml_workspace_name'] ]
  steps:
    - task: AzureCLI@1
      displayName: Build train pipeline
      inputs:
        azureSubscription: DataOpsML Azure DevOps ML Model CI/CD pipeline
        scriptLocation: inlineScript
        workingDirectory: Python/azureml-pipeline-databricks
        inlineScript: |
          set -eux  # fail on error
          env
          az extension  add -n azure-cli-ml
          az ml folder attach -g $(RESOURCE_GROUP) -w $(WORKSPACE_NAME)
          az ml datastore attach-blob -a stmyappdataopstrtest -c trainingdata -n trainingdata
          python -m ml_service.pipelines.build_train_pipeline
